## 技术原理

声音转换插件是对实时语音转换核心 API 的封装。通过调用[声网视频 SDK v4.1.1](https://docs.agora.io/cn/video-call-4.x/product_video_ng?platform=Android) 的 [setExtensionProperty](https://docs.agora.io/cn/video-call-4.x/API%20Reference/java_ng/API/toc_network.html#api_irtcengine_setextensionproperty) 或 [setExtensionPropertyWithVendor](https://docs.agora.io/cn/video-call-4.x/API%20Reference/ios_ng/API/toc_network.html#api_irtcengine_setextensionproperty)方法，传入指定的 `key` 和 `value` 参数，你可以快速集成。支持的 key 详见[插件的 key 概览]()。



## 前提条件

- Android 开发环境需满足以下要求：
  - Android Studio 4.1 以上版本。
  - 运行 Android 5.0 或以上版本的真机（非模拟器）。
- iOS 开发环境需满足以下要求：
  - Xcode 12.0 或以上版本。
  - 运行 iOS 12.0 或以上版本的真机（非模拟器）。



## 示例项目

| 平台    | 语言  | 示例项目                                                     |
| :------ | :---- | :----------------------------------------------------------- |
| Android | Java  | [地址](https://github.com/data-baker/DBOfflineVoiceConversionFilter) |
| iOS     | Swift | [地址](https://github.com/data-baker/DBOfflineVoiceConversionFilter) |

## 集成和调用流程

### 准备工作

### 使用声网 SDK 实现视频通话

 离线声音转换插件需要与[声网视频 SDK v4.1.1](https://docs.agora.io/cn/video-call-4.x/product_video_ng?platform=Android) 搭配使用。参考以下文档集成视频 SDK v4.1.1 并实现基础的视频通话：

* [实现视频通话（Android）](https://docs.agora.io/cn/video-call-4.x/start_call_android_ng?platform=Android#建立项目)
* [实现视频通话（iOS）](https://docs.agora.io/cn/video-call-4.x/start_call_ios_ng?platform=iOS#创建项目)

### 运行步骤

#### Android

1. 进入[github](https://github.com/data-baker/DBOfflineVoiceConversionFilter) 下载**标贝离线声音转换**的 Android 插件包。
2. 解压文件夹，将 `.aar` 文件保存到项目文件夹的 `/app/libs` 路径。

3. 打开 `app/build.gradle` 文件，在 `dependencies` 中添加如下行：

```
implementation fileTree(dir: "libs", include: ["*.jar", "*.aar"])
```

#### iOS 

1. 进入[githbub](https://github.com/data-baker/DBOfflineVoiceConversionFilter) 下载 **[OfflineVoiceConversionFilter](https://github.com/data-baker/OfflineVoiceConversionFilter)**的iOS安装包

   OfflineVoiceConversionFilter基于声网引擎4.1.1进行开发的，可以通过pod导入依赖

   ```ruby
    pod 'AgoraRtcEngine_iOS' , '~> 4.1.1'
   ```

2. 解压文件夹，将`DataBakerOfflineVC.xcframework` 拖入到.xcodeproj下面；

3. 在使用的地方`import DataBakerOfflineVC` 即可



#### 调用流程（Android）

1. `RtcEngineConfig` 实例调用 `addExtension`，将插件添加到 SDK 中。

   ```java
   config.addExtension("databaker_offlinevc");
   ```

2. `RtcEngineConfig` 实例设置 `mExtensionObserver` 监听器。

   ```java
   private final IMediaExtensionObserver mMediaExtensionObserver = new IMediaExtensionObserver() {
       @Override
       public void onEvent(String provider, String extension, String key, String value) {
           Log.i(TAG, "onEvent | provider: " + provider + ", extension: " + extension + ", key: " + key + ", value: " + value); 
       }
   }
   ```

   ```java
   config.mExtensionObserver = mMediaExtensionObserver;
   ```

3. 在加入频道前，调用 `enableExtension` 开启插件。

   ```java
   mRtcEngine.enableExtension("DataBaker","OfflineVoiceConversion", true);
   ```

4. 开始授权

   ```java
   setExtensionProperty("DataBaker", "OfflineVoiceConversion", "authors", "{\"clientId\": \"xxx...\", \"clientSecret\": \"xxx...\", \"voiceName\": \"Vc_luoli\", \"isLog\": \"true\"}");
   ```



#### 调用流程（iOS）

离线声音转换提供了低延迟的声音转换的功能，可以在没有网络延迟的条件下稳定的进行声音转换，共支持五个音色，分别为萝莉、大叔、空灵、霸王龙、机械音,对应的发音人名称如下；

```swift
 let voiceArray = ["Vc_luoli","Vc_dashu","Vc_kongling","Vc_bawanglong","Vc_zhongjinshu"]
```

1. **设置鉴权**

   离线声音转换的鉴权方式是按照装机量进行授权的，需要传入ClientId

   示例代码：

   ```swift
       let authorInfo = [
               "clientId":clientId,
               "clientSecret":clientSecret,
               "voiceName":voiceName
           ]
           let isValid = JSONSerialization.isValidJSONObject(authorInfo)
           guard isValid else {
               print("the Author json is invalid")
               return
           }
           let jsonString = getJSONStringFromDictionary(dictionary: authorInfo as NSDictionary)
   
   agoraKit.setExtensionPropertyWithVendor(DBVoiceConvertFilterManager.vendorName(), extension: AUDIO_FILTER_NAME, key: "authors", value: jsonString)
   
   ```

   > 其中authors标识授权相关的消息
   >
   > clientId和clientSecret分别表示授权相关的信息,voiceName表示目标转换发音人，之前前面所说的六个音色；

2. **切换发音人**

   切换声音转换的发音人

   ```swift
    agoraKit.setExtensionPropertyWithVendor(DBVoiceConvertFilterManager.vendorName(), extension: AUDIO_FILTER_NAME, key: "voiceName", value: value)
   
   ```

   > 设置发音人，用于单独切换发音人的设置

3. **开启插件**

   设置声音转换插件的开关

   ```swift
           agoraKit.setExtensionPropertyWithVendor(SimpleFilterManager.vendorName(), extension: AUDIO_FILTER_NAME, key: "isLog", value: String(true))
   
   ```

   > `String(true)`表示开启插件，` String(false)`表示关闭插件

4. **开启日志**

   设置声音转换的日志开关，开启日志后，插件会在本地路径保存转换前后的语音信息

   ```swift
           agoraKit.setExtensionPropertyWithVendor(DBVoiceConvertFilterManager.vendorName(), extension: AUDIO_FILTER_NAME, key: "isLog", value: String(true))
   
   ```

   > 表示是否开启日志，一般用于debug的时候排查问题使用




#### 运行步骤（示例项目-Android）

1. 在 Android Studio 中打开示例项目，地址https://github.com/data-baker/DBOfflineVoiceConversionFilter；
2. 将项目与 Gradle 文件同步。
3. 打开 `com/offline/conversion/MainActivity.java` 文件，将 `#YOUR APP ID#` 替换为你的 App ID。获取 App ID 请参考[开始使用声网平台](https://docs.agora.io/cn/Agora Platform/get_appid_token?platform=All Platforms)。
4. 打开 `com/offline/conversion/MainActivity.java` 文件，填入 `clientId` 和 `clientSecret`。
5. 连接一台 Android 真机（非模拟器），运行项目。

#### 运行步骤（示例项目-iOS）

1. 在 Xcode中打开示例项目，[地址](https://github.com/data-baker/DBOfflineVoiceConversionFilter)。
2. 将DataBakerOfflineVC.xcframework拖入到项目中。
3. 打开 `KeyCenter` 文件，将 `#YOUR APP ID#` 替换为你的 App ID。获取 App ID 请参考[开始使用声网平台](https://docs.agora.io/cn/Agora Platform/get_appid_token?platform=All Platforms)。
4. 打开 `SimpleFilterMain` 文件，填入 `clientId` 和 `clientSecret` (示例项目保存在`Keycenter`文件中,和AppID一起进行替换即可)。
5. 连接一台 iOS 真机（非模拟器），运行项目。

### 预期效果

运行成功后，示例项目会安装到你的 Android 或 iOS 设备上。

**Android**

1. 打开App, 选择初始化SDK,成功后输入频道号进入插件系统；
2. 点击插件插件开关，可以控制插件；
3. 点击音色列表后切换对应的转换音色；

**iOS**

1. 启动App,输入频道号后，进入插件系统成功后可以看到插件开关，音色列表按钮；
1. 点击插件插件开关，可以控制插件；
1. 点击音色列表后切换对应的转换音色；

